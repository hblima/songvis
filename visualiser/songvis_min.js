var RedYlBlu=["#a50026","#d73027","#f46d43","#fdae61","#fee090","#e0f3f8","#abd9e9","#74add1","#4575b4","#313695"],RedYlGn=["#a50026","#d73027","#f46d43","#fdae61","#fee08b","#ffffbf","#d9ef8b","#a6d96a","#66bd63","#1a9850","#006837"],Spectral=["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2"],styles={controls:{drawBlocks:"none",drawWaveform:!0,drawPattern:!1,renderMusicPlayer:!1,toolTip:!0},layout:{border:"solid 1px #000"},glyphs:{fill:"yellow"},blocks:{colors:RedYlBlu,strokecolor:"black",opacity:1,strokewidth:.5},pattern:{enable:"true",seed:.5,strokecolor:"black",strokewidth:1,strokeopacity:1},waveform:{scale:2,scalebias:4,color:"black",opacity_disabled:0,opacity_enabled:1,strokecolor:"white",strokewidth:.5,strokeopacity:.5}},cScale=d3.scaleQuantile().domain([0,.5,1]).range(styles.blocks.colors),glyphs={genre:{classical:"img/classical.svg",dance:"img/dance.svg",hiphop:"img/hiphop.svg",jazz:"img/jazz.svg",pop:"img/pop.svg",rb:"img/rb.svg",rock:"img/rock.svg"},instrument:{voice:"img/vocal.svg",guitar:"img/guitar.svg",piano:"img/piano.svg",violin:"img/violin.svg",drums:"img/drum.svg",saxophone:"img/sax.svg"},bpm:{slow:"img/slow.svg",fast:"img/fast.svg"},danceability:{danceable:"img/danceable.svg",notdanceable:"img/notdanceable.svg"},mood:{1:"img/mood/1f600.svg",.989:"img/mood/1f603.svg",.911:"img/mood/1f60c.svg",.877:"img/mood/1f601.svg",.848:"img/mood/1f604.svg",.835:"img/mood/1f606.svg",.612:"img/mood/1f62c.svg",.539:"img/mood/1f62f.svg",.346:"img/mood/1f627.svg",.328:"img/mood/1f62a.svg",.289:"img/mood/1f61e.svg",.26:"img/mood/1f614.svg",.192:"img/mood/1f623.svg",.03:"img/mood/1f629.svg",.009:"img/mood/1f610.svg",0:"img/mood/1f615.svg"}},band={0:"high",1:"middle_high",2:"middle_low",3:"low"},mood_array=[0,.009,.03,.192,.26,.289,.328,.346,.539,.612,.835,.848,.877,.911,.989,1];function SongVis(r,i,t,n,e){if(void 0!==n){var o=new XMLHttpRequest;songData={},o.overrideMimeType("application/json"),o.open("GET",t,!0),o.onload=function(){JSON.parse(o.responseText);var o=new XMLHttpRequest;songData={},o.overrideMimeType("application/json"),o.open("GET",t,!0),o.onload=function(){var t=JSON.parse(o.responseText);songData=t;var e=calculateDimensions(i),a=createLayout(r,e);renderGlyphsSection(a,e,songData);renderWaveSection(a,e,songData),renderMusicPlayer(styles.controls.toolTip,e,a,n,songData),toolTip(styles.controls.toolTip,e,a,songData)},o.send(null)},o.send(null)}else{o=new XMLHttpRequest;songData={},o.overrideMimeType("application/json"),o.open("GET",t,!0),o.onload=function(){var t=JSON.parse(o.responseText);songData=t;var e=calculateDimensions(i),a=createLayout(r,e);renderGlyphsSection(a,e,songData);renderWaveSection(a,e,songData),renderMusicPlayer(styles.controls.toolTip,e,a,n,songData)},o.send(null)}}function calculateDimensions(t){var e=(1+Math.sqrt(5))/2;return{height:+t,width:+Math.floor(t*e),glyphSection:{height:+(Math.floor(t*e)/5)},waveSection:{height:+(t-Math.floor(t*e)/5)}}}function calculateBlockPositions(t){n_of_blocks_x=20,n_of_blocks_y=4;for(var e=t.width/n_of_blocks_x,a=t.waveSection.height/n_of_blocks_y,o=[],r=0;r<n_of_blocks_y;r++)for(var i=0;i<n_of_blocks_x;i++){var n={x:i*e,y:r*a,i:r,j:i};o.push(n)}return o}function createLayout(t,e){return d3.selectAll("#"+t).append("g").append("svg").attr("name","SongVis").attr("height",e.height).attr("width",e.width).style("border",styles.layout.border)}function renderGlyphsSection(e,a,o){var r=calculateBlockPositions(a),t=e.append("g").attr("name","glyphs");if(t.append("svg").attr("height",a.glyphSection.height).attr("width",a.glyphSection.height).attr("transform","translate(0,0)").append("image").attr("xlink:href",glyphs.genre[o.glyphs.genre.value]).attr("height","100%").attr("width","100%"),t.append("svg").attr("height",a.glyphSection.height).attr("width",a.glyphSection.height).attr("x",1*a.glyphSection.height).attr("y",0).append("svg:image").attr("xlink:href",glyphs.instrument[o.glyphs.instrument.value]).attr("height",a.glyphSection.height).attr("width",a.glyphSection.height),!0===styles.controls.drawPattern)var i=!0;else i=!1;var n=t.append("svg").attr("height",a.glyphSection.height).attr("width",a.glyphSection.height).attr("x",2*a.glyphSection.height).attr("y",0);n.append("svg:image").attr("xlink:href",glyphs.bpm[o.glyphs.bpm.value]).attr("height",a.glyphSection.height).attr("width",a.glyphSection.height);var l=n.append("rect").attr("height","7%").attr("width",a.glyphSection.height).attr("x",0).attr("y",0);if(!0===i?l.attr("fill",RedYlBlu[1]):l.attr("fill","none"),n.on("mouseover",function(){waveSection=e.select("g:nth-child(2)"),waveSection.selectAll("g").remove(),waveSection.selectAll("svg").remove(),n.append("rect").attr("height","7%").attr("width",a.glyphSection.height).attr("x",0).attr("y",0).attr("fill",RedYlBlu[1]),!0===s&&drawBlocks("mood",a,waveSection,r,o),drawPattern(!0,a,waveSection,r,o)}).on("mouseout",function(){!1===i&&(waveSection.selectAll("g").remove(),waveSection.selectAll("svg").remove(),n.selectAll("rect").remove(),!0===s?drawBlocks("mood",a,waveSection,r,o):(drawBlocks("none",a,waveSection,r,o),drawWaveform(!0,a,waveSection,o)))}).on("click",function(){n.append("rect").attr("height","7%").attr("width",a.glyphSection.height).attr("x",0).attr("y",0).attr("fill",RedYlBlu[1]);!1===i?(waveSection.selectAll("g").remove(),waveSection.selectAll("svg").remove(),!0===s?(i=!0,drawBlocks("mood",a,waveSection,r,o),drawPattern(!0,a,waveSection,r,o)):drawPattern(i=!0,a,waveSection,r,o)):i=(!1===s?n.selectAll("rect").remove():(n.selectAll("rect").remove(),drawBlocks("mood",a,waveSection,r,o)),!1)}),"mood"===styles.controls.drawBlocks)var s=!0;else s=!1;var c=t.append("svg").attr("height",a.glyphSection.height).attr("width",a.glyphSection.height).attr("x",3*a.glyphSection.height).attr("y",0);c.append("svg:image").attr("xlink:href",glyphs.mood[getClosestValue(mood_array,o.glyphs.mood.value)]).attr("height",a.glyphSection.height).attr("width",a.glyphSection.height);var g=c.append("rect").attr("height","7%").attr("width",a.glyphSection.height).attr("x",0).attr("y",0);return!0===s?g.attr("fill",RedYlBlu[1]):g.attr("fill","none"),c.on("mouseover",function(){var t=c.append("rect").attr("height","7%").attr("width",a.glyphSection.height).attr("x",0).attr("y",0).attr("fill",RedYlBlu[1]);waveSection=e.select("g:nth-child(2)"),waveSection.selectAll("g").remove(),waveSection.selectAll("svg").remove(),!0===i?(t.attr("fill",RedYlBlu[1]),drawBlocks("mood",a,waveSection,r,o),drawPattern(!0,a,waveSection,r,o)):(t.attr("fill",RedYlBlu[1]),drawBlocks("mood",a,waveSection,r,o))}).on("mouseout",function(){!1===s&&(waveSection.selectAll("g").remove(),waveSection.selectAll("svg").remove(),c.selectAll("rect").remove(),!0===i?drawPattern(!0,a,waveSection,r,o):(drawBlocks("none",a,waveSection,r,o),drawWaveform(!0,a,waveSection,o)))}).on("click",function(){c.append("rect").attr("height","7%").attr("width",a.glyphSection.height).attr("x",0).attr("y",0).attr("fill",RedYlBlu[1]);s=!1===s?(waveSection.selectAll("g").remove(),waveSection.selectAll("svg").remove(),!0===i?(drawBlocks("mood",a,waveSection,r,o),drawPattern(!0,a,waveSection,r,o)):drawBlocks("mood",a,waveSection,r,o),!0):(c.selectAll("rect").remove(),!1)}),t.append("svg:image").attr("xlink:href",glyphs.danceability[o.glyphs.danceability.value]).attr("height",a.glyphSection.height).attr("width",a.glyphSection.height).attr("transform","translate("+4*a.glyphSection.height+",0)"),t}function renderWaveSection(t,e,a){var o=t.append("g").attr("name","wave").attr("width",e.width).attr("height",e.waveSection.height).attr("transform","translate(0,"+e.glyphSection.height+")"),r=calculateBlockPositions(e);drawBlocks(styles.controls.drawBlocks,e,o,r,a),drawWaveform(styles.controls.drawWaveform,e,o,a),drawPattern(styles.controls.drawPattern,e,o,r,a)}function drawBlocks(e,t,a,o,r){n_of_blocks_x=20,n_of_blocks_y=4;var i=t.width/n_of_blocks_x,n=t.waveSection.height/n_of_blocks_y;a.append("g").attr("name","blocks").append("svg").attr("width","100%").attr("height","100%").selectAll(".rect").data(o).enter().append("rect").attr("width",i).attr("height",n).attr("transform",function(t){return"translate("+t.x+","+t.y+")"}).attr("stroke",styles.blocks.strokecolor).attr("stroke-width",styles.blocks.strokewidth*n/100).attr("opacity",styles.blocks.opacity).attr("fill",function(t){return"none"!==e?cScale(1-pickColor(e,t.i,t.j,r)):"none"})}function drawWaveform(t,e,a,o){if(!0===t)var r=styles.waveform.opacity_enabled;else r=styles.waveform.opacity_disabled;var i=e.waveSection.height,n=e.width,l=a.append("svg").attr("width","100%").attr("height","100%"),s=Object.keys(o.samples).map(function(t){return o.samples[t]}),c=s.length,g=d3.scaleLinear().domain([0,c]).range([1,n]),h=d3.scaleSymlog().domain([-1,0,1]).range([0,i/+styles.waveform.scale]),d=i/+styles.waveform.scalebias,v=d3.area().x(function(t,e){return g(e)}).y0(function(t){return h(t)-d}).y1(function(t){return i-h(t)+d});l.append("path").attr("d",v(s)).attr("fill",styles.waveform.color).attr("opacity",r).attr("stroke",styles.waveform.strokecolor).attr("stroke-width",styles.waveform.strokewidth*e.waveSection.height/100).attr("stroke-opacity",styles.waveform.strokeopacity)}function drawPattern(t,e,a,o,r){if(!0===t){var i=20,n=5,l=e.width/i,s=e.waveSection.height/n,c=0;e.height<=100&&(i=10,n=4,l=e.width/i,s=e.waveSection.height/n,c=1);for(var g,h,d=[{x:0,y:0},{x:1,y:-2},{x:2,y:0},{x:3,y:2},{x:4,y:0},{x:5,y:-2},{x:6,y:0},{x:7,y:2},{x:8,y:0}],v=d3.scaleLinear().domain([0,8]).range([1,l-1]),p=d3.scaleLinear().domain([-2,0,2]).range([0,s/4]),m=a.append("svg"),y=e.waveSection.height/10,f=0;f<i;){var w=r.wave[f+c].avg_bpm;w<80?h=.1:80<=w&&w<120?h=.5:120<=w&&(h=1);var u=d3.line().x(function(t){return v(t.x)}).y(function(t){return p(t.y)}).curve(d3.curveBundle.beta(h));for(g=0;g<10;g++)m.append("path").datum(d).attr("d",u).attr("transform","translate("+f*l+","+g*y+")");f++}m.selectAll("path").attr("fill","none").attr("stroke",styles.pattern.strokecolor).attr("stroke-width",styles.pattern.strokewidth).attr("stroke-opacity",styles.pattern.strokeopacity)}}function getClosestValue(t,e){for(var a=0;e>t[a];)a++;return Math.abs(t[a-1]-e)<=Math.abs(t[a]-e)?t[a-1]:t[a]}function pickColor(t,e,a,o){var r,i={bpm:{g:"bpm",avg:"avg_bpm"},mood:{g:"mood",avg:"avg_mood"}},n=o.wave[a].strong_peak,l=o.wave[a].energy_band[band[e]],s=o.wave[a][i[t].avg],c=o.glyphs[i[t].g].value;"bpm"===t&&(s/=200,c/=200);return c<=.5?(r=.2)+12*l+.02*n+r*s:.2+12*l+.02*n+(r=.4)*s}function renderInteraction(){}function renderMusicPlayer(t,e,a,o,r){if(!0===t){var i=e.height/5,n=e.width;a.append("g").attr("name","music").attr("width",n).attr("height",i).attr("transform","translate(0,"+e.height/1.2+")").append("rect")}}function toolTip(t,e,a,o){if(!0===t)var r={name:o.metadata.filename,bpm:o.glyphs.bpm.bpm,mood:o.glyphs.mood.value,genre:o.glyphs.genre.value,instrument:o.glyphs.instrument.value,danceability:o.glyphs.danceability.value},i=(a.append("g").attr("width",e.width).attr("height",e.waveSection.height).attr("x",0).attr("y",0).append("svg").attr("width","100%").attr("height","100%").attr("name","toolTipArea"),d3.select(".songvis").append("div").append("rect").attr("width",50).attr("height",50).attr("fill","white").style("position","absolute").style("z-index","10").style("visibility","hidden").text(r.name).on("mouseover",function(){return i.style("visibility","visible")}).on("mousemove",function(){return i.style("top",event.pageY-10+"px").style("left",event.pageX+10+"px")}).on("mouseout",function(){return i.style("visibility","hidden")}))}Math.sign=function(t){return t<0?-1:0===t?0:0<t?1:void 0},Math.log1p=Math.log1p||function(t){return Math.log(1+t)};